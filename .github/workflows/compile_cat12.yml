name: Build CAT12 standalone

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v3
      - name: Update
        run: make update
      - name: Checkout SPM
        uses: actions/checkout@v3
        with:
          repository: spm/spm
          path: spm
      - name: Install CAT12 in SPM toolbox
        run: |
          mkdir -p spm/toolbox/cat12
          rsync -a --exclude='.git' \
            --exclude='batches/' \
            --exclude='catQC/' \
            --exclude='check_pipeline/' \
            --exclude='development/' \
            --exclude='html/' \
            --exclude='internal/' \
            --exclude='mexmaca/' \
            --exclude='mexmaci/' \
            ./ spm/toolbox/cat12/
      - name: Setup MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          release: R2023b
      - name: Build standalone
        run: |
          matlab -batch "compile; cd(fullfile('spm','config')); spm_make_standalone(fullfile('..','standalone'), {'toolbox/cat12'});"
      - name: Zip standalone
        run: |
          cd spm
          if [ "$RUNNER_OS" = "Windows" ]; then
            7z a ../cat12-${{ matrix.os }}.zip standalone > /dev/null
          else
            zip -r ../cat12-${{ matrix.os }}.zip standalone > /dev/null
          fi
      - uses: actions/upload-artifact@v4
        with:
          name: cat12-${{ matrix.os }}
          path: cat12-${{ matrix.os }}.zip

